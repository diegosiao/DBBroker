# DBBroker 3.0 (WIP ⚒️)

A free, lightweight and simple to use NuGet package to manage Oracle data.

## Philosophy

- We do not believe that applications should bear the responsibility to manage the schema and/or "migrations.
  
  - Why? Databases exist to serve multiple applications.

- Applications should reflect databases as clients.

  - Why? Applications are not database owners.

## Quick Start

**Step 1:** Install DBBroker globally.

```bash
dotnet install DBBroker -g
```

**Step 2:** Add `DBBroker.Core` package to your project.

```bash
dotnet nuget add DBBroker.Core
```

**Step 3:** Create a dbbroker.json file at the root of your project.

```bash
dotnet dbbroker init --connection-string "" --vendor Oracle
```

**Step 4:** Sync your project with your database. That command will generate the Entity Data Models (/Edms folder on the project's root by default).

```bash
dotnet dbbroker sync
```

## Examples

Entity persistence.

```C#
    // Dependency Injection
    public Repository(IDbBroker<CustomerEdm> dbbroker){
        _dbBroker = dbBroker;
    }
    ...
    // Entity Data Models - Edm classes are generated by DBBroker
    var customer = new CustomerEdm();
    customer.Name = "John Three Sixteen";
    customer.Birthday = new DateTime(1980, 3, 16);

    var id = await _dbBroker.InsertAsync(customer);
```

Entity persistence with transactions.

```C#
    using (var connection = [Dapper].GetTransaction(IsolationLevel...))
    {
        var transaction = connection.GetTransaction(IsolationLevel...);

        try 
        {
            var customer = new CustomerEdm();
            customer.Name = "John Three Sixteen";
            customer.Birthday = new DateTime(1980, 3, 16);

            var customerId = await _dbBroker.InsertAsync(customer, transaction);

            var car = new CarEdm();
            car.Model = "Renault Twingo";
            car.Year = 2001;
            car.CustomerId = customerId;

            await _dbBroker.InsertAsync(car, transaction);
            transaction.Commit();
        }
        catch(Exception ex)
        {
            transaction.Rollback();
        }
    }

```

Default `SELECT`.

```C#
    var customer = await _dbBroker.LoadAsync<CustomerEdm>(id: "");
```

Custom `SELECT`.

```C#
public class SalesView : IDatabaseView
{
    // Always write an ANSI compliant SELECT
    public string Sql => "SELECT Date, Value FROM SALES WHERE SalerId = @SalerId";
}
```

```C#
    var salesView = new SalesView(new { SalerId = 1 });
    foreach(var record in salesView.Select().Order(x => x.Value))
    {
        Console.WriteLine($"Date: {record.Date}; Value {record.Value}");
    }
```

```C#
//built in select
var customers = new CustomerEdm()
        .SelectAsync(
            depth: 2,
            where: 
                [
                    "Address.City LIKE @City",
                    $"{nameof(CustomerEdm.Birthday)} = @Birthday"
                ])
            parameters: [...];
```
