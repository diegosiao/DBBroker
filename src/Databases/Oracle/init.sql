ALTER SESSION SET "_ORACLE_SCRIPT"=true;

-- Create user and grant privileges
CREATE USER DBBROKER IDENTIFIED BY DBBroker_1 DEFAULT TABLESPACE users TEMPORARY TABLESPACE temp;
GRANT CONNECT, RESOURCE, CREATE VIEW TO DBBROKER;

ALTER USER DBBROKER quota 200M on USERS;

-- Connect to the new schema
ALTER SESSION SET CURRENT_SCHEMA = DBBROKER;

-- Create the sequences and triggers for auto-increment
CREATE SEQUENCE CUSTOMERS_NOTES_STATUS_SEQ START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE ORDERS_NOTES_SEQ START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE ORDERS_STATUS_SEQ START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE PROMOTIONS_SEQ START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE PROMOTIONS_ENROLLMENTS_SEQ START WITH 1 INCREMENT BY 1 NOCACHE;

-- #TABLES
CREATE TABLE SUPPORTED_TYPES (
    VARCHAR2_TYPE_MAX VARCHAR2(4000) NOT NULL,
    VARCHAR2_TYPE_MIN VARCHAR2(1) NOT NULL,
    DATE_TYPE DATE NOT NULL,
    TIMESTAMP_TYPE TIMESTAMP NOT NULL,
    NUMBER_TYPE NUMBER NOT NULL,
    BOOLEAN_TYPE NUMBER(1) NOT NULL,
    BLOB_TYPE BLOB,
    CLOB_TYPE CLOB,
    NCLOB_TYPE NCLOB,
    UUID_TYPE RAW(16) NOT NULL,
    RAW_TYPE RAW(16) NOT NULL,
    FLOAT_TYPE FLOAT(126) NOT NULL,
    DOUBLE_TYPE BINARY_DOUBLE NOT NULL,
    DECIMAL_TYPE NUMBER(10, 2) NOT NULL,
    DECIMAL_TYPE_SCALE_0 NUMBER(10, 0) NOT NULL,
    DECIMAL_TYPE_SCALE_5 NUMBER(10, 5) NOT NULL,
    DECIMAL_TYPE_SCALE_10 NUMBER(10, 10) NOT NULL,
    DECIMAL_TYPE_SCALE_15 NUMBER(20, 15) NOT NULL,
    DECIMAL_TYPE_SCALE_20 NUMBER(30, 20) NOT NULL,
    INTERVAL_TYPE INTERVAL DAY TO SECOND NOT NULL,
    INTERVAL_YEAR_TYPE INTERVAL YEAR TO MONTH NOT NULL,
    XMLTYPE_TYPE XMLTYPE NOT NULL,
    JSON_TYPE CLOB CHECK (JSON_TYPE IS JSON) NOT NULL
);

CREATE TABLE CUSTOMERS (
    ID RAW(16) PRIMARY KEY,
    ADDRESS_ID RAW(16),
    NAME VARCHAR2(250) NOT NULL,
    EMAIL VARCHAR2(250),
    BIRTHDAY DATE,
    ORDERS_TOTAL NUMBER,
    CREATED_AT TIMESTAMP NOT NULL,
    CREATED_BY VARCHAR2(50) NOT NULL,
    MODIFIED_AT TIMESTAMP,
    MODIFIED_BY VARCHAR2(50)
);

CREATE TABLE ADDRESSES (
    ID RAW(16) PRIMARY KEY,
    STREET VARCHAR2(100),
    CITY VARCHAR2(50),
    STATE VARCHAR2(50),
    POSTAL_CODE VARCHAR2(10),
    COUNTRY VARCHAR2(50)
);

CREATE TABLE CUSTOMERS_NOTES_STATUS (
    ID NUMBER PRIMARY KEY,
    STATUS VARCHAR2(50)
);

CREATE TABLE CUSTOMERS_NOTES (
    ID RAW(16) PRIMARY KEY,
    CUSTOMER_ID RAW(16),
    STATUS_ID NUMBER,
    NOTE_CONTENT VARCHAR2(50) NOT NULL
);

CREATE TABLE ORDERS (
    ID RAW(16) PRIMARY KEY,
    CUSTOMER_ID RAW(16) NOT NULL,
    BILLING_ADDRESS_ID RAW(16) NOT NULL,
    SHIPPING_ADDRESS_ID RAW(16) NOT NULL,
    STATUS_ID NUMBER,
    CREATED_AT TIMESTAMP NOT NULL,
    CREATED_BY VARCHAR2(50) NOT NULL,
    MODIFIED_AT TIMESTAMP,
    MODIFIED_BY VARCHAR2(50)
);

CREATE TABLE ORDERS_STATUS (
    ID NUMBER PRIMARY KEY,
    STATUS VARCHAR2(50) NOT NULL
);

CREATE TABLE ORDERS_NOTES (
    ID NUMBER PRIMARY KEY,
    ORDER_ID RAW(16) NOT NULL,
    NOTE_CONTENT VARCHAR2(1024) NOT NULL
);

CREATE TABLE PRODUCTS (
    ID RAW(16) PRIMARY KEY,
    PRODUCT_NAME VARCHAR2(50) NOT NULL,
    PRICE NUMBER(10, 2) DEFAULT 0
);

CREATE TABLE ORDERS_PRODUCTS (
    ID RAW(16) PRIMARY KEY,
    ORDER_ID RAW(16) NOT NULL,
    PRODUCT_ID RAW(16) NOT NULL
);

CREATE TABLE PROMOTIONS (
    ID NUMBER PRIMARY KEY,
    TITLE VARCHAR2(50) NOT NULL,
    EXPIRATION TIMESTAMP NOT NULL
);

CREATE TABLE PROMOTIONS_ENROLLMENTS (
    ID NUMBER PRIMARY KEY,
    CUSTOMER_ID RAW(16) NOT NULL,
    PROMOTION_ID NUMBER NOT NULL
);

-- #CONSTRAINTS
ALTER TABLE CUSTOMERS
ADD CONSTRAINT FK_CUSTOMERS_ADDRESS_ID FOREIGN KEY (ADDRESS_ID) REFERENCES ADDRESSES(ID);
--
ALTER TABLE ORDERS
ADD CONSTRAINT FK_ORDERS_CUSTOMER_ID FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMERS(ID);
ALTER TABLE ORDERS
ADD CONSTRAINT FK_ORDERS_STATUS_ID FOREIGN KEY (STATUS_ID) REFERENCES ORDERS_STATUS(ID);
ALTER TABLE ORDERS
ADD CONSTRAINT FK_ORDERS_BILLING_ADDRESS_ID FOREIGN KEY (BILLING_ADDRESS_ID) REFERENCES ADDRESSES(ID);
ALTER TABLE ORDERS
ADD CONSTRAINT FK_ORDERS_SHIPPING_ADDRESS_ID FOREIGN KEY (SHIPPING_ADDRESS_ID) REFERENCES ADDRESSES(ID);
--
ALTER TABLE CUSTOMERS_NOTES
ADD CONSTRAINT FK_CUSTOMERS_NOTES_CUSTOMER_ID FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMERS(ID);
ALTER TABLE CUSTOMERS_NOTES
ADD CONSTRAINT FK_CUSTOMERS_NOTES_STATUS_ID FOREIGN KEY (STATUS_ID) REFERENCES CUSTOMERS_NOTES_STATUS(ID);
--
ALTER TABLE ORDERS_NOTES
ADD CONSTRAINT FK_ORDERS_NOTES_ORDER_ID FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ID);
--
ALTER TABLE ORDERS_PRODUCTS
ADD CONSTRAINT FK_ORDERS_PRODUCTS_ORDER_ID FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ID);
ALTER TABLE ORDERS_PRODUCTS
ADD CONSTRAINT FK_ORDERS_PRODUCTS_PRODUCT_ID FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCTS(ID);
--
ALTER TABLE PROMOTIONS_ENROLLMENTS
ADD CONSTRAINT FK_PROMO_ENRO_CUSTOMER_ID FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMERS(ID);
ALTER TABLE PROMOTIONS_ENROLLMENTS
ADD CONSTRAINT FK_PROMO_ENRO_PROMOTION_ID FOREIGN KEY (PROMOTION_ID) REFERENCES PROMOTIONS(ID);


-- #VIEWS
CREATE OR REPLACE VIEW VW_ORDER_SUMMARY
AS
SELECT 	c.NAME AS CUSTOMER_NAME, 
		o.STATUS_ID AS ORDER_STATUS_ID, 
		s.STATUS AS ORDER_STATUS, 
		(SELECT COUNT(*) FROM ORDERS_PRODUCTS op WHERE op.ORDER_ID = o.ID ) AS NUMBER_OF_ITEMS
FROM ORDERS o
JOIN CUSTOMERS c ON c.ID = o.CUSTOMER_ID 
JOIN ORDERS_STATUS s ON s.ID = o.STATUS_ID 
ORDER BY o.CREATED_AT DESC;

CREATE OR REPLACE VIEW VW_ORDERS
AS
SELECT 
		o.ID AS ORDER_ID, 
		o.CREATED_AT AS ORDER_CREATION,
		o.CUSTOMER_ID,
		c.NAME AS CUSTOMER_NAME,
		p.ID AS PRODUCT_ID,
		p.PRODUCT_NAME,
		p.PRICE
FROM ORDERS o
JOIN CUSTOMERS c ON c.ID = o.CUSTOMER_ID
JOIN ORDERS_STATUS s ON s.ID = o.STATUS_ID
JOIN ORDERS_PRODUCTS op ON op.ORDER_ID = o.ID
JOIN PRODUCTS p ON p.ID = op.PRODUCT_ID;


-- #SEEDING DATA
INSERT INTO ADDRESSES(ID, STREET, CITY, STATE, POSTAL_CODE, COUNTRY)
VALUES(HEXTORAW('A1B2C3D4E5F60718293A4B5C6D7E8F90'), '123 Main St', 'Springfield', 'IL', '62701', 'USA');

INSERT INTO ADDRESSES(ID, STREET, CITY, STATE, POSTAL_CODE, COUNTRY)
VALUES(HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), '456 Elm St', 'Springfield', 'IL', '62702', 'USA');

INSERT INTO ADDRESSES(ID, STREET, CITY, STATE, POSTAL_CODE, COUNTRY)
VALUES(HEXTORAW('FEDCBA0987654321FEDCBA0987654321'), '789 Oak St', 'Springfield', 'IL', '62703', 'USA');

INSERT INTO CUSTOMERS(ID, ADDRESS_ID, NAME, BIRTHDAY, ORDERS_TOTAL, CREATED_AT, CREATED_BY)
VALUES(HEXTORAW('00112233445566778899AABBCCDDEEFF'), HEXTORAW('A1B2C3D4E5F60718293A4B5C6D7E8F90'), 'John Doe', TO_DATE('1980-05-15', 'YYYY-MM-DD'), 0, SYSTIMESTAMP, 'system');

INSERT INTO CUSTOMERS(ID, ADDRESS_ID, NAME, BIRTHDAY, ORDERS_TOTAL, CREATED_AT, CREATED_BY)
VALUES(HEXTORAW('FFEEDDCCBBAA99887766554433221100'), HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), 'Jane Smith', TO_DATE('1990-08-22', 'YYYY-MM-DD'), 0, SYSTIMESTAMP, 'system');

INSERT INTO CUSTOMERS(ID, ADDRESS_ID, NAME, BIRTHDAY, ORDERS_TOTAL, CREATED_AT, CREATED_BY)
VALUES(HEXTORAW('89ABCDEF0123456789ABCDEF01234567'), HEXTORAW('FEDCBA0987654321FEDCBA0987654321'), 'Alice Johnson', TO_DATE('1985-12-05', 'YYYY-MM-DD'), 0, SYSTIMESTAMP, 'system');

INSERT INTO CUSTOMERS_NOTES_STATUS(ID, STATUS)
VALUES(CUSTOMERS_NOTES_STATUS_SEQ.nextval, 'Active');

INSERT INTO CUSTOMERS_NOTES_STATUS(ID, STATUS)
VALUES(CUSTOMERS_NOTES_STATUS_SEQ.nextval, 'Inactive');

INSERT INTO CUSTOMERS_NOTES(ID, CUSTOMER_ID, STATUS_ID, NOTE_CONTENT)
VALUES(HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), HEXTORAW('00112233445566778899AABBCCDDEEFF'), 1, 'First note for John Doe.');

INSERT INTO CUSTOMERS_NOTES(ID, CUSTOMER_ID, STATUS_ID, NOTE_CONTENT)
VALUES(HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), HEXTORAW('00112233445566778899AABBCCDDEEFF'), 1, 'Second note for John Doe.');

INSERT INTO PRODUCTS(ID, PRODUCT_NAME, PRICE)
VALUES(HEXTORAW('2468ACE13579BDF02468ACE13579BDF0'), 'Product A', 5.99);

INSERT INTO PRODUCTS(ID, PRODUCT_NAME, PRICE)
VALUES(HEXTORAW('13579BDF2468ACE013579BDF2468ACE0'), 'Product B', 15.49);

INSERT INTO PRODUCTS(ID, PRODUCT_NAME, PRICE)
VALUES(HEXTORAW('0F1E2D3C4B5A69780F1E2D3C4B5A6978'), 'Product C', 25.00);

INSERT INTO PRODUCTS(ID, PRODUCT_NAME, PRICE)
VALUES(HEXTORAW('9F8E7D6C5B4A3B29F8E7D6C5B4A3B29'), 'Product D', 45.75);

INSERT INTO ORDERS_STATUS(ID, STATUS)
VALUES(ORDERS_STATUS_SEQ.nextval, 'New');

INSERT INTO ORDERS_STATUS(ID, STATUS)
VALUES(ORDERS_STATUS_SEQ.nextval, 'Pending');

INSERT INTO ORDERS_STATUS(ID, STATUS)
VALUES(ORDERS_STATUS_SEQ.nextval, 'Dispatched');

INSERT INTO ORDERS_STATUS(ID, STATUS)
VALUES(ORDERS_STATUS_SEQ.nextval, 'Delivered');

INSERT INTO ORDERS_STATUS(ID, STATUS)
VALUES(ORDERS_STATUS_SEQ.nextval, 'Canceled');

INSERT INTO ORDERS(ID, CUSTOMER_ID, BILLING_ADDRESS_ID, SHIPPING_ADDRESS_ID, STATUS_ID, CREATED_AT, CREATED_BY)
VALUES(HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), HEXTORAW('00112233445566778899AABBCCDDEEFF'), HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), 1, SYSTIMESTAMP, 'system');

INSERT INTO ORDERS_PRODUCTS(ID, ORDER_ID, PRODUCT_ID)
VALUES(HEXTORAW('11223344556677889900AABBCCDDEEFF'), HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), HEXTORAW('2468ACE13579BDF02468ACE13579BDF0'));

INSERT INTO ORDERS_PRODUCTS(ID, ORDER_ID, PRODUCT_ID)
VALUES(HEXTORAW('FFEEDDCCBBAA99887766554433221100'), HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), HEXTORAW('13579BDF2468ACE013579BDF2468ACE0'));   

INSERT INTO ORDERS_PRODUCTS(ID, ORDER_ID, PRODUCT_ID)
VALUES(HEXTORAW('A1B2C3D4E5F60718293A4B5C6D7E8F90'), HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), HEXTORAW('0F1E2D3C4B5A69780F1E2D3C4B5A6978')); 

INSERT INTO ORDERS_NOTES(ID, ORDER_ID, NOTE_CONTENT)
VALUES(ORDERS_NOTES_SEQ.nextval, HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), 'First note for the order.');

INSERT INTO ORDERS_NOTES(ID, ORDER_ID, NOTE_CONTENT)
VALUES(ORDERS_NOTES_SEQ.nextval, HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), 'Second note for the order.');

INSERT INTO ORDERS_NOTES(ID, ORDER_ID, NOTE_CONTENT)
VALUES(ORDERS_NOTES_SEQ.nextval, HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), 'Third note for the order.');

INSERT INTO ORDERS_NOTES(ID, ORDER_ID, NOTE_CONTENT)
VALUES(ORDERS_NOTES_SEQ.nextval, HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), 'Fourth note for the order.'); 

INSERT INTO ORDERS_NOTES(ID, ORDER_ID, NOTE_CONTENT)
VALUES(ORDERS_NOTES_SEQ.nextval, HEXTORAW('ABCDEF1234567890ABCDEF1234567890'), 'Fifth note for the order.');

INSERT INTO ORDERS(ID, CUSTOMER_ID, BILLING_ADDRESS_ID, SHIPPING_ADDRESS_ID, STATUS_ID, CREATED_AT, CREATED_BY)
VALUES(HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), HEXTORAW('FFEEDDCCBBAA99887766554433221100'), HEXTORAW('A1B2C3D4E5F60718293A4B5C6D7E8F90'), HEXTORAW('FEDCBA0987654321FEDCBA0987654321'), 2, SYSTIMESTAMP, 'system');

INSERT INTO ORDERS_PRODUCTS(ID, ORDER_ID, PRODUCT_ID)
VALUES(HEXTORAW('22334455667788990011AABBCCDDEEFF'), HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), HEXTORAW('9F8E7D6C5B4A3B29F8E7D6C5B4A3B29'));

INSERT INTO ORDERS_PRODUCTS(ID, ORDER_ID, PRODUCT_ID)
VALUES(HEXTORAW('EEFFDDBBCCAA99887766554433221100'), HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), HEXTORAW('2468ACE13579BDF02468ACE13579BDF0'));

INSERT INTO ORDERS_NOTES(ID, ORDER_ID, NOTE_CONTENT)
VALUES(ORDERS_NOTES_SEQ.nextval, HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), 'First note for the second order.');

INSERT INTO ORDERS_NOTES(ID, ORDER_ID, NOTE_CONTENT)
VALUES(ORDERS_NOTES_SEQ.nextval, HEXTORAW('1234567890ABCDEF1234567890ABCDEF'), 'Second note for the second order.');

INSERT INTO ORDERS(ID, CUSTOMER_ID, BILLING_ADDRESS_ID, SHIPPING_ADDRESS_ID, STATUS_ID, CREATED_AT, CREATED_BY)
VALUES(HEXTORAW('0F1E2D3C4B5A69780F1E2D3C4B5A6978'), HEXTORAW('89ABCDEF0123456789ABCDEF01234567'), HEXTORAW('FEDCBA0987654321FEDCBA0987654321'), HEXTORAW('A1B2C3D4E5F60718293A4B5C6D7E8F90'), 3, SYSTIMESTAMP, 'system');

INSERT INTO ORDERS_PRODUCTS(ID, ORDER_ID, PRODUCT_ID)
VALUES(HEXTORAW('33445566778899001122AABBCCDDEEFF'), HEXTORAW('0F1E2D3C4B5A69780F1E2D3C4B5A6978'), HEXTORAW('13579BDF2468ACE013579BDF2468ACE0'));

INSERT INTO ORDERS_PRODUCTS(ID, ORDER_ID, PRODUCT_ID)
VALUES(HEXTORAW('DDEEFF00112233445566778899AABBCC'), HEXTORAW('0F1E2D3C4B5A69780F1E2D3C4B5A6978'), HEXTORAW('0F1E2D3C4B5A69780F1E2D3C4B5A6978'));

INSERT INTO ORDERS_NOTES(ID, ORDER_ID, NOTE_CONTENT)
VALUES(ORDERS_NOTES_SEQ.nextval, HEXTORAW('0F1E2D3C4B5A69780F1E2D3C4B5A6978'), 'First note for the third order.');

INSERT INTO PROMOTIONS(ID, TITLE, EXPIRATION)
VALUES(PROMOTIONS_SEQ.nextval, 'Spring Sale', SYSTIMESTAMP + INTERVAL '30' DAY);

INSERT INTO PROMOTIONS(ID, TITLE, EXPIRATION)
VALUES(PROMOTIONS_SEQ.nextval, 'Summer Sale', SYSTIMESTAMP + INTERVAL '60' DAY);

INSERT INTO PROMOTIONS_ENROLLMENTS(ID, CUSTOMER_ID, PROMOTION_ID)
VALUES(PROMOTIONS_ENROLLMENTS_SEQ.nextval, HEXTORAW('00112233445566778899AABBCCDDEEFF'), 1);

INSERT INTO PROMOTIONS_ENROLLMENTS(ID, CUSTOMER_ID, PROMOTION_ID)
VALUES(PROMOTIONS_ENROLLMENTS_SEQ.nextval, HEXTORAW('FFEEDDCCBBAA99887766554433221100'), 1);

INSERT INTO PROMOTIONS_ENROLLMENTS(ID, CUSTOMER_ID, PROMOTION_ID)
VALUES(PROMOTIONS_ENROLLMENTS_SEQ.nextval, HEXTORAW('89ABCDEF0123456789ABCDEF01234567'), 2);

INSERT INTO PROMOTIONS_ENROLLMENTS(ID, CUSTOMER_ID, PROMOTION_ID)
VALUES(PROMOTIONS_ENROLLMENTS_SEQ.nextval, HEXTORAW('00112233445566778899AABBCCDDEEFF'), 2);

COMMIT;